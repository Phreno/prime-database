#!/bin/bash
# ..............
# [K3rn€l_P4n1k]
# ..............

# =====
# SETUP
# =====
#
# Installe la base de données des nombres premiers.
# L'installation suit les étapes suivantes:
# - Téléchargement des zip contenant les nombres premiers
# - Extraction des fichiers puis renommage
# - Sauvegarde du répertoire ( permet le traitement du setup offline )

primeDB_SETUP_SH="${BASH_SOURCE[0]:-$(realpath ${0})}"
primeDB_SETUP_SH_DIR="$( dirname ${primeDB_SETUP_SH} )"

#
# Gestion des erreurs
#
source "${primeDB_SETUP_SH_DIR}/../lib/error.profile"

#
# Import des dépendances
#
source "${primeDB_SETUP_SH_DIR}/../lib/base.profile"
source "${primeDB_SETUP_SH_DIR}/../lib/core.profile"
source "${primeDB_SETUP_SH_DIR}/../lib/setup.profile"

#
# Téléchargement des données à installer
#
primeDB_download(){
  echo ">> INFO download primeDB data"
  primeDB_setup_removeData
  primeDB_setup_downloadPrimes
  primeDB_setup_cleanFolder
  echo ">> INFO download done"
}

#
# Extrait les fichiers téléchargés
#
primeDB_extract(){
  echo ">> INFO extract files"
  primeDB_setup_unzipPrimes
  primeDB_setup_removeZipFiles
  primeDB_setup_normalizeDatafileName
  echo ">> INFO extract done"
}

#
# Transforme les fichiers téléchargés en fichiers csv
#
primeDB_transform(){
  echo ">> INFO transform data files"
  rm "${primeDB_IMPORT}" -f
  for chunk in $( seq 1 1 $( primeDB_CORE_countChunks ) ); do
    echo ".. INFO add chunk ${chunk} to working data"
    primeDB_setup_chunk_toCsv "${chunk}"
  done
  echo ">> INFO transform done"
}

#
# Charge les données dans la base de données locale
#
primeDB_load(){
  echo ">> INFO import csv"
  primeDB_setup_createDB
  primeDB_setup_importCsv
  echo ">> INFO import done"
}

# primeDB_download
# primeDB_extract
# primeDB_transform
primeDB_load
# primeDB_setup_backupData
